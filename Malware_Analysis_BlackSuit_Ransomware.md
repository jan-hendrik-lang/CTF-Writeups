# BlackSuit Ransomware Lab - Malware Analysis Writeup

## Level
Hardcore

## **Scenario**
A ransomware attack was detected in an organization, and forensic investigation revealed a suspicious executable executed on multiple endpoints before files were encrypted. The **Incident Response (IR) team** isolated the malware sample and provided it for in-depth analysis. Our goal is to analyze the ransomware, uncover its behavior, and identify weaknesses that could aid in recovery and future prevention.

---

## **Questions & Answers**

### **Q1: What is the subsystem value of the malware?**
**Answer:** `IMAGE_SUBSYSTEM_WINDOWS_GUI`

**Analysis:**
Using **CFF Explorer**, we examined the **Optional Header** and found the `Subsystem` field set to `0x0002`, confirming that the ransomware is designed to run in a **Windows GUI environment**.

---

### **Q2: How many embedded resources does this malware contain?**
**Answer:** `7`

**Analysis:**
Navigating to the **Resource Editor** in `CFF Explorer`, we identified and manually counted **7 embedded resources** within the malware.

---

### **Q3: What is the original name of the binary that the malware impersonates?**
**Answer:** `QHAccount.exe`

**Analysis:**
The malware attempts to evade detection by disguising itself as a **Qihoo 360 security binary**. This was discovered by inspecting the **OriginalFilename** field in the executable metadata using **Pestudio**.

---

### **Q4: What XOR key is used to decrypt the shellcode?**
**Answer:** `k5XBuqr4f@BsrTNHVuKjko\x00`

**Analysis:**
- We set breakpoints in **x32dbg** on critical API calls (`VirtualAlloc`, `VirtualProtect`, `WriteProcessMemory`).
- The ransomware decrypted a shellcode payload using an **XOR decryption routine**.
- Observing memory in the **Dump window**, we identified the XOR key used for decryption.

---

### **Q5: What is the resource ID of the malicious resource?**
**Tested IDs:** `101, 104, 105, 864` (Incorrect)

**Next Steps:**
- Set breakpoints on `FindResourceExA` instead of `FindResourceA`.
- Extract **high-entropy resources** to determine the correct ID.

---

### **Q6: What hexadecimal value in the Machine field indicates that this is a 32-bit executable?**
**Answer:** `0x014C`

**Analysis:**
- Examined the **File Header** in `CFF Explorer`.
- Found that the **Machine** field value is `0x014C`, confirming it is a **32-bit PE executable**.
- Verified in **Pestudio** under file architecture details.

---

## **Next Steps**
- **Determine the correct malicious resource ID** by analyzing `FindResourceExA` API calls.
- **Continue with Q7-Q16**, focusing on:
  - Payload execution techniques.
  - Encryption methodology (AES + RSA key management).
  - Lateral movement (network protocol usage).

---

## **Conclusion & Mitigation Steps**
ðŸ”¹ **Process Monitoring**: Monitor suspicious process creations using EDR solutions.
ðŸ”¹ **File Execution Control**: Restrict execution of unknown binaries using application whitelisting.
ðŸ”¹ **Backup Protection**: Prevent ransomware from deleting system backups (e.g., Volume Shadow Copy protection).
ðŸ”¹ **Network Security**: Implement **firewall rules** to block command-and-control (C2) traffic.

---

## **References**
- [CFF Explorer](https://ntcore.com/?page_id=388)
- [x32dbg Debugging Guide](https://x64dbg.com/)
- [Pestudio](https://www.winitor.com/)
- [FLOSS - FireEye String Extractor](https://github.com/mandiant/flare-floss)
